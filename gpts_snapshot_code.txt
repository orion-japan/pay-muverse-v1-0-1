=== package.json (name/version/scripts) ===
{
  "name": "sofia_register_flow_v1",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "ESLINT_USE_FLAT_CONFIG=false eslint \"src/**/*.{ts,tsx,js,jsx}\"",
    "typecheck": "tsc -p tsconfig.json --noEmit",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:vitest": "vitest run",
    "test:vitest:watch": "vitest",
    "compress-images": "tsx src/compressPublicImages.ts"
  },
  "dependencies": {
    "@hello-pangea/dnd": "^18.0.1",
    "@radix-ui/react-slot": "^1.2.3",
    "@sendgrid/mail": "^8.1.5",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/ssr": "^0.6.1",
    "@supabase/supabase-js": "^2.56.1",
    "@types/pg": "^8.15.5",
    "@vercel/postgres": "^0.10.0",
    "axios": "^1.10.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cookie": "^1.0.2",
    "crypto-js": "^4.2.0",
    "dayjs": "^1.11.18",
    "firebase": "^11.10.0",
    "firebase-admin": "^13.4.0",
    "framer-motion": "^12.23.12",
    "googleapis": "^150.0.1",
    "highlight.js": "^11.11.1",
    "jsonwebtoken": "^9.0.2",
    "lucide-react": "^0.525.0",
    "luxon": "^3.7.1",
    "next": "15.3.4",
    "nodemailer": "^7.0.5",
    "openai": "^5.19.1",
    "payjp": "^2.3.0",
    "pg": "^8.16.3",
    "qrcode": "^1.5.4",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-is": "^19.2.0",
    "react-markdown": "^10.1.0",
    "react-swipeable": "^7.0.2",
    "react-toastify": "^11.0.5",
    "recharts": "^3.1.2",
    "rehype-highlight": "^7.0.2",
    "remark-breaks": "^4.0.0",
    "remark-emoji": "^5.0.2",
    "remark-gfm": "^4.0.1",
    "resend": "^6.0.2",
    "swr": "^2.3.6",
    "tesseract.js": "2.1.5",
    "tesseract.js-core": "2.2.0",
    "tinify": "^1.8.1",
    "web-push": "^3.6.7",
    "zustand": "^5.0.8"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@eslint/js": "8.57.0",
    "@types/cookie": "^0.6.0",
    "@types/crypto-js": "^4.2.2",
    "@types/jest": "29.5.12",
    "@types/jsonwebtoken": "^9",
    "@types/node": "^20.14.11",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.3",
    "@types/react-is": "^19",
    "@types/react-toastify": "^4.1.0",
    "@types/web-push": "^3.6.4",
    "@typescript-eslint/eslint-plugin": "6.21.0",
    "@typescript-eslint/parser": "6.21.0",
    "esbuild": "^0.25.11",
    "esbuild-register": "^3.6.0",
    "eslint": "8.57.0",
    "eslint-config-next": "14.2.5",
    "eslint-plugin-react-hooks": "^5.2.0",
    "jest": "29.7.0",
    "ts-jest": "29.1.1",
    "tsx": "^4.20.4",
    "typescript": "5.5.4",
    "vite-tsconfig-paths": "^5.1.4",
    "vitest": "^3.2.4"
  },
  "resolutions": {
    "eslint": "8.57.1",
    "@eslint/js": "8.57.0"
  },
  "engines": {
    "node": "20.x"
  },
  "packageManager": "yarn@4.10.3"
}

=== Node / npm / Yarn / Next / TS ===
v20.19.5
10.8.2
4.10.3
    "next": "15.3.4",
    "typescript": "5.5.4",

=== /app/api 配下（一部） ===
src/app/api/shipmates/route.ts
src/app/api/auth/session/route.ts
src/app/api/secure-action/route.ts
src/app/api/mu/list/route.ts
src/app/api/mu/summary/route.ts
src/app/api/mu/turns/route.ts
src/app/api/account-status.ts
src/app/api/logs/route.ts
src/app/api/jp-holiday/route.ts
src/app/api/mu-logs/route.ts
src/app/api/mu-logs/users/route.ts
src/app/api/board-posts/route.ts
src/app/api/payjp/card-form/route.ts
src/app/api/payjp/register-card/route.ts
src/app/api/payjp/webhook/route.ts
src/app/api/payjp/change-card/route.ts
src/app/api/payjp/create-customer/route.ts
src/app/api/payjp/charge/route.ts
src/app/api/payjp/create-checkout-session/route.ts
src/app/api/ping/route.ts
src/app/api/update-ship-visibility.ts
src/app/api/set-leader.ts/route.ts
src/app/api/logout/route.ts
src/app/api/notification-settings/route.ts
src/app/api/notification-settings/save/route.ts
src/app/api/resend-verification/route.ts
src/app/api/components/YourForm.tsx
src/app/api/components/FormSection.tsx
src/app/api/album/insert/route.ts
src/app/api/delete-post/route.ts
src/app/api/reactions/history/route.ts
src/app/api/reactions/counts/route.ts
src/app/api/reactions/summary/route.ts
src/app/api/reactions/toggle/route.ts
src/app/api/resolve-usercode/route.ts
src/app/api/get-user-info/route.ts
src/app/api/supabase/register-user/route.ts
src/app/api/get-current-user/route.ts
src/app/api/update-name-visibility/route.ts
src/app/api/my-reactions/route.ts
src/app/api/ops/user-search/route.ts
src/app/api/health/supabase/route.ts
src/app/api/media/route.ts
src/app/api/mu-ai/send-token/route.ts
src/app/api/q/log/route.ts
src/app/api/q/audit/route.ts
src/app/api/q/category_today/route.ts
src/app/api/q/unified/route.ts
src/app/api/q/daily_with_carry/route.ts
src/app/api/push-test/route.ts
src/app/api/billing/set-pro/route.ts
src/app/api/billing/status/route.ts
src/app/api/iboard-posts/route.ts
src/app/api/create-profile/route.ts
src/app/api/invites/create/route.ts
src/app/api/follow/route.ts
src/app/api/protected/route.ts
src/app/api/ai-format/route.ts
src/app/api/firebase/custom-token/route.ts
src/app/api/user/ship-visibility.ts
src/app/api/vision-criteria/history/route.ts
src/app/api/vision-criteria/route.ts
src/app/api/vision-criteria/check/route.ts
src/app/api/practice/export/route.ts
src/app/api/practice/draft/route.ts
src/app/api/practice/logs/route.ts
src/app/api/practice/calendar/route.ts
src/app/api/resolve-so/route.ts
src/app/api/sofia-logs/route.ts
src/app/api/sofia-logs/users/route.ts
src/app/api/get-user-code/route.ts
src/app/api/login/route.ts
src/app/api/kyomeikai/next/route.ts
src/app/api/jp-holidays/route.ts
src/app/api/plan/check/route.ts
src/app/api/self-posts/route.ts
src/app/api/resolve-user/route.ts
src/app/api/self/create-thread/route.ts
src/app/api/self/add-comment/route.ts
src/app/api/mypage/update/route.ts
src/app/api/mypage/upload-avatar/route.ts
src/app/api/mypage/me/route.ts
src/app/api/ainori/next/route.ts
src/app/api/update-ship-visibility/route.ts
src/app/api/webhook/route.ts
src/app/api/upload-avatar/route.ts
src/app/api/copy-image-to-public/route.ts
src/app/api/ai/phase/route.ts
src/app/api/ai/opening/route.ts
src/app/api/fshot/save/route.ts
src/app/api/fshot/echo/route.ts
src/app/api/fshot/start/route.ts
src/app/api/zapier/route.ts
src/app/api/check-user/route.ts
src/app/api/create-thread-post/route.ts
src/app/api/upload-public-image/route.ts
src/app/api/write-sheet/route.ts
src/app/api/verify-signed/route.ts
src/app/api/resonance/counts/route.ts
src/app/api/resonance/toggle/route.ts
src/app/api/push/send/route.ts
src/app/api/push/vapid-public-key/route.ts
src/app/api/push/dispatch/route.ts
src/app/api/push/subscribe/route.ts
src/app/api/push/save-subscription/route.ts
src/app/api/push/test/route.ts
src/app/api/pay/webhook/route.ts
src/app/api/pay/layout.tsx
src/app/api/pay/subscribe/route.ts
src/app/api/pay/cancel-subscription/route.ts
src/app/api/guard/iros/route.ts
src/app/api/guard/sofia/route.ts
src/app/api/register-push/route.ts
src/app/api/comments/route.ts
src/app/api/telemetry/route.ts
src/app/api/telemetry/collect/route.ts
src/app/api/write-payment-sheet/route.ts
src/app/api/verify-complete/route.ts
src/app/api/register/route.ts
src/app/api/register/apply-initial-credit/route.ts
src/app/api/register/consume-invite/route.ts
src/app/api/my/send-invite-email/route.ts
src/app/api/my/invite-info/route.ts
src/app/api/check-follow/route.ts
src/app/api/agent/iros.zip
src/app/api/agent/analyze/route.ts
src/app/api/agent/mui/route.ts
src/app/api/agent/iros/route.ts
src/app/api/agent/muai/route.ts
src/app/api/agent/mtalk/route.ts
src/app/api/friends/request/route.ts
src/app/api/friends/list/route.ts
src/app/api/friends/respond/route.ts
src/app/api/env-check/route.ts
src/app/api/upload/sign/route.ts
src/app/api/daily-checks/route.ts
src/app/api/create-invite/route.ts
src/app/api/my-posts/route.ts
src/app/api/receive-log/route.ts
src/app/api/talk/send/route.ts
src/app/api/talk/meta/route.ts
src/app/api/talk/unread-count/route.ts
src/app/api/talk/messages/route.ts
src/app/api/talk/mark-read/route.ts
src/app/api/talk/start/route.ts
src/app/api/thread/reply/route.ts
src/app/api/thread/comment/route.ts
src/app/api/ship-visibility/route.ts
src/app/api/avatar/[userCode]/route.ts
src/app/api/unfollow/route.ts
src/app/api/save-subscription/route.ts
src/app/api/upload-post/route.ts
src/app/api/conv/create/route.ts
src/app/api/conv/list/route.ts
src/app/api/conv/route.ts
src/app/api/conv/[id]/route.ts
src/app/api/call-mu-ai/route.ts
src/app/api/me/route.ts
src/app/api/thread-posts/route.ts
src/app/api/_debug/supabase/route.ts
src/app/api/invite/check/route.ts
src/app/api/check-friend/route.ts
src/app/api/get-profile/route.ts
src/app/api/i-posts/route.ts
src/app/api/userinfo/route.ts
src/app/api/debug/env/route.ts
src/app/api/attendance/history/route.ts
src/app/api/attendance/export/route.ts
src/app/api/attendance/days/route.ts
src/app/api/attendance/checkin/route.ts
src/app/api/post-image/route.ts
src/app/api/account-status/route.ts
src/app/api/account-status/refresh/route.ts
src/app/api/trace/route.ts
src/app/api/zoom/webhook/route.ts
src/app/api/whoami/route.ts
src/app/api/credits/balance/route.ts
src/app/api/credits/power-meter/route.ts
src/app/api/credits/award/route.ts
src/app/api/dev/qtest/route.ts
src/app/api/update-profile/route.ts
src/app/api/link-user/route.ts
src/app/api/notifications/route.ts
src/app/api/notifications/mark-read/route.ts
src/app/api/qcode/log/route.ts
src/app/api/qcode/append/route.ts
src/app/api/qcode/q-heatmap/QHeatmap.tsx
src/app/api/qcode/q-daily/route.ts
src/app/api/qcode/q-features/route.ts
src/app/api/knowledge/get/route.ts
src/app/api/knowledge/search/route.ts
src/app/api/knowledge/toc/route.ts
src/app/api/thread-stats/route.ts
src/app/api/user-info/route.ts
src/app/api/visions/history/route.ts
src/app/api/visions/delete/route.ts
src/app/api/visions/move-to-history/route.ts
src/app/api/visions/route.ts
src/app/api/visions/auto-pause/route.ts
src/app/api/visions/auto-archive/route.ts

=== エージェント関連候補 ===
src/app/iros2/layout.tsx:9:export default function IrosLayout({ children }: { children: React.ReactNode }) {
src/app/iros2/page.tsx:29:export default function IrosPage() {
src/app/iros2/page.tsx:251:        Sofia_AI を開始中…
src/app/lecture/q-analysis/page.tsx:286:      await fetch('/api/mu/turns', {
src/app/ops/sofia-logs/page.tsx:61:export default function SofiaLogsPage() {
src/app/ops/sofia-logs/page.tsx:211:          <h1 className="muLogs__title">Sofia Logs Viewer</h1>
src/app/chat/layout.tsx:2:import '@/components/SofiaChat/SofiaChat.css';
src/app/chat/page.tsx:1:import SofiaChat from '@/components/SofiaChat/SofiaChat';
src/app/chat/page.tsx:5:export default async function SofiaPage({
src/app/chat/page.tsx:16:        <SofiaChat agent="mu" open={typeof open === 'string' ? open : undefined} />
src/app/(whatever)/components/MuiOcrPanel.tsx:9:export default function MuiOcrPanel({ initial = '' }: EditorProps) {
src/app/LayoutClient.tsx:91:  const isIros = pathname?.startsWith('/iros') === true;
src/app/LayoutClient.tsx:92:  const isSofia = pathname?.startsWith('/sofia') === true;
src/app/LayoutClient.tsx:103:      {!(isMuAI || isIros || isSofia) && mounted && (
src/app/LayoutClient.tsx:127:      {!(isMuAI || isIros || isSofia) && mounted && (
src/app/LayoutClient.tsx:182:  const isIros = pathname?.startsWith('/iros') === true;
src/app/LayoutClient.tsx:183:  const isSofia = pathname?.startsWith('/sofia') === true;
src/app/(q)/MuSummaryButton.tsx:8:    return `/api/mu/summary?${p.toString()}`;
src/app/mui/stage2/page.tsx:1:// /app/mui/stage2/page.tsx
src/app/mui/stage2/page.tsx:5:import StageTwoPanel from '@/components/mui/StageTwoPanel';
src/app/mui/stage1/page.tsx:1:// src/app/mui/stage1/page.tsx
src/app/mui/stage1/page.tsx:4:import StageOnePanel from '@/components/mui/StageOnePanel';
src/app/mui/stage1/page.tsx:6:import '@/components/mui/StageOnePanel/StageOnePanel.css';
src/app/mui/stage3/page.tsx:1:import StageThreePanel from '@/components/mui/StageThreePanel';
src/app/mui/ClientAuthGate.tsx:4:import MuiChat from '@/components/mui/MuiChat';
src/app/mui/ClientAuthGate.tsx:36: * いずれかでログインを検知したら <MuiChat /> を表示。
src/app/mui/ClientAuthGate.tsx:102:  return ok ? <MuiChat /> : <>{children}</>;
src/app/mui/page.tsx:3:import MuiChat from '@/components/mui/MuiChat';
src/app/mui/page.tsx:22:        <MuiChat />
src/app/mui/page.tsx:27:            <h1 className="mui-title">Mui — 恋愛相談</h1>
src/app/mui/stage4/page.tsx:1:import StageFourPanel from '@/components/mui/StageFourPanel';
src/app/lessons/page.tsx:18:        フェーズ・位相ベクトル・認識深度レベルなど、Sofia構造の学習ページです。
src/app/talk/[threadId]/page.tsx:91:  const [showMirra, setShowMirra] = useState(false);
src/app/talk/[threadId]/page.tsx:92:  const [mirraText, setMirraText] = useState('');
src/app/talk/[threadId]/page.tsx:93:  const [mirraReply, setMirraReply] = useState<string | null>(null);
src/app/talk/[threadId]/page.tsx:94:  const [mirraPending, setMirraPending] = useState(false);
src/app/talk/[threadId]/page.tsx:332:  const sendToMirra = async () => {
src/app/talk/[threadId]/page.tsx:334:    setMirraPending(true);
src/app/talk/[threadId]/page.tsx:335:    setMirraReply(null);
src/app/talk/[threadId]/page.tsx:344:      setMirraReply(json?.reply ?? '');
src/app/talk/[threadId]/page.tsx:345:      setMirraText('');
src/app/talk/[threadId]/page.tsx:351:      setMirraPending(false);
src/app/talk/[threadId]/page.tsx:358:    if (sp.get('agent') === 'mirra') setShowMirra(true);
src/app/talk/[threadId]/page.tsx:475:        onClick={() => setShowMirra((v) => !v)}
src/app/talk/[threadId]/page.tsx:498:      {showMirra && (
src/app/talk/[threadId]/page.tsx:529:              onClick={() => setShowMirra(false)}
src/app/talk/[threadId]/page.tsx:540:              onChange={(e) => setMirraText(e.target.value)}
src/app/talk/[threadId]/page.tsx:555:                onClick={sendToMirra}
src/app/iros/layout.tsx:1:// src/app/iros/page.tsx
src/app/iros/layout.tsx:3:import IrosChat from '@/ui/iroschat/IrosChat';
src/app/iros/layout.tsx:11:      <IrosChat />
src/app/iros/page.tsx:3:import IrosLayout from '@/ui/iroschat/IrosLayout';
src/app/iros/page.tsx:4:import IrosChat from '@/ui/iroschat/IrosChat';
src/app/iros/page.tsx:8:    <IrosLayout>
src/app/iros/page.tsx:9:      <IrosChat />
src/app/iros/page.tsx:10:    </IrosLayout>
src/app/page.tsx:78:  const [isIrosAllowed, setIsIrosAllowed] = useState<boolean | null>(null);
src/app/page.tsx:81:  const [irosReloadLock, setIrosReloadLock] = useState<boolean>(false);
src/app/page.tsx:94:      setIrosReloadLock(true);
src/app/page.tsx:95:      const t = setTimeout(() => setIrosReloadLock(false), 3000); // ← 3秒
src/app/page.tsx:131:      setIsIrosAllowed(null);
src/app/page.tsx:197:        setIsIrosAllowed(allowed);
src/app/page.tsx:199:        if (!aborted) setIsIrosAllowed(false); // 取得失敗時は閉じておく
src/app/page.tsx:261:      if (isIrosAllowed === false) {
src/app/page.tsx:343:          const isIros = item.link === '/iros';
src/app/page.tsx:345:          const disabledByRole = isIros && isIrosAllowed === false;
src/app/page.tsx:347:          const disabledByReload = isIros && irosReloadLock;
src/app/api/mu/list/route.ts:1:// src/app/api/mu/list/route.ts
src/app/api/mu/summary/route.ts:285:    const turnRes = await postJson(req, '/api/mu/turns', {
src/app/api/mu/turns/route.ts:1:// src/app/api/mu/turns/route.ts
src/app/api/components/FormSection.tsx:132:          placeholder="Sofiaの名前"
src/app/api/q/unified/route.ts:8:import { mapQToColor } from '@/lib/sofia/qcolor';
src/app/api/sofia-logs/route.ts:9:type SofiaConversation = {
src/app/api/sofia-logs/route.ts:20:type SofiaTurnRaw = {
src/app/api/sofia-logs/route.ts:72:        .maybeSingle<SofiaConversation>(); // ← 型指定
src/app/api/sofia-logs/route.ts:88:      // Sofiaの行を取得（conv_id/role/content は無い！）
src/app/api/sofia-logs/route.ts:113:        .returns<SofiaTurnRaw[]>(); // ← 型指定
src/app/api/sofia-logs/route.ts:168:        .returns<SofiaConversation[]>(); // ← 型指定
src/app/api/self-posts/route.ts:31:/** 超簡易ヒューリスティック（必要なら後でVision/Sofiaの分類器に置換） */
src/app/api/ai/phase/route.ts:5:import { buildSystemPrompt, buildUserPrompt } from '@/lib/mui/buildSystemPrompt';
src/app/api/ai/phase/route.ts:6:import { phaseTemplate } from '@/lib/mui/prompt';
src/app/api/ai/phase/route.ts:7:import { callAgentMui, parseAgentTextToUi, saveStage } from '@/lib/mui/api';
src/app/api/ai/phase/route.ts:8:import { type ConversationStage, type AgentMuiPayload, type AiTurn } from '@/lib/mui/types';
src/app/api/ai/phase/route.ts:92:    const payload: AgentMuiPayload = { system, user, phase: stage };
src/app/api/ai/phase/route.ts:93:    const agentRes = await callAgentMui<any>(payload);
src/app/api/ai/opening/route.ts:5:import { buildSystemPrompt, buildUserPrompt } from '@/lib/mui/buildSystemPrompt';
src/app/api/ai/opening/route.ts:6:import { phaseTemplate } from '@/lib/mui/prompt';
src/app/api/ai/opening/route.ts:7:import { type AiOpening, type ConversationStage, type AgentMuiPayload } from '@/lib/mui/types';
src/app/api/ai/opening/route.ts:8:import { callAgentMui, parseAgentTextToUi } from '@/lib/mui/api';
src/app/api/ai/opening/route.ts:66:    const payload: AgentMuiPayload = { system, user, phase: 'opening' };
src/app/api/ai/opening/route.ts:67:    const agentRes = await callAgentMui<any>(payload);
src/app/api/guard/iros/route.ts:1:// src/app/api/guard/sofia/route.ts
src/app/api/agent/mui/log/route.ts:1:// src/app/api/agent/mui/log/route.ts
src/app/api/agent/mui/log/route.ts:63:    console.error('[agent/mui/log]', e);
src/app/api/agent/mui/stage1/analyze/route.ts:49:        content: 'あなたは恋愛コミュニケーション解析AI「Mui」。JSONのみ返す。',
src/app/api/agent/mui/stage1/result/route.ts:19: * GET /api/agent/mui/stage1/result?conv=MU-xxxx
src/app/api/agent/mui/route.ts:1:// src/app/api/agent/mui/route.ts
src/app/api/agent/mui/route.ts:9:import { retrieveKnowledge } from '@/lib/sofia/retrieve';
src/app/api/agent/mui/route.ts:10:import { nextQFrom } from '@/lib/mui/nextQFrom';
src/app/api/agent/mui/route.ts:11:import { chargeIfNeeded } from '@/lib/mui/billing';
src/app/api/agent/mui/route.ts:13:import { inferPhase as inferPhaseFn } from '@/lib/mui/inferPhase';
src/app/api/agent/mui/route.ts:14:import { estimateSelfAcceptance as estimateSelfAcceptanceFn } from '@/lib/mui/estimateSelfAcceptance';
src/app/api/agent/mui/route.ts:229:    console.error('[Mui API] Error:', e);
src/app/api/agent/mui/stage/save/route.ts:19: * POST /api/agent/mui/stage/save
src/app/api/agent/mui/case/[seed]/quartet/route.ts:1:// src/app/api/agent/mui/case/[seed]/quartet/route.ts
src/app/api/agent/mui/ocr/intent/route.ts:1:// app/api/agent/mui/ocr/intent/route.ts
src/app/api/agent/mui/handlers/chat.ts:6:type MuiBodyLocal = {
src/app/api/agent/mui/handlers/chat.ts:28:  raw: MuiBodyLocal,
src/app/api/agent/mui/handlers/chat.ts:88:    'あなたは恋愛スクショ相談「Mui」の会話パートナーです。短く温かく、実用的に返答します。',
src/app/api/agent/mui/handlers/formatOnly.ts:3:type MuiBodyLocal = {
src/app/api/agent/mui/handlers/formatOnly.ts:59:  raw: MuiBodyLocal,
src/app/api/agent/mui/handlers/coachFromText.ts:6:type MuiBodyLocal = {
src/app/api/agent/mui/handlers/coachFromText.ts:78:  raw: MuiBodyLocal,
src/app/api/agent/mui/handlers/coachFromText.ts:105:あなたは恋愛相談AI「Mui」のナビゲータです。A=自分（相談者）、B=相手（対象）として読み解きます。
src/app/api/agent/iros/compose/route.ts:1:// src/app/api/agent/iros/compose/route.ts
src/app/api/agent/iros/compose/route.ts:124: * POST /api/agent/iros/compose
src/app/api/agent/iros/reply/route.ts:1:// /src/app/api/agent/iros/reply/route.ts
src/app/api/agent/iros/reply/route.ts:3:import { generateIrosReply } from '@/lib/iros/generate';
src/app/api/agent/iros/reply/route.ts:4:import { deriveFinalMode } from '@/lib/iros/intent';
src/app/api/agent/iros/reply/route.ts:5:import { analyzeFocus } from '@/lib/iros/focusCore'; // ← Qコード/位相・深度の観測用
src/app/api/agent/iros/reply/route.ts:64:    // --- Iros 応答生成（system prompt は generate 側でのみ構築する＝重複排除） ---
src/app/api/agent/iros/reply/route.ts:65:    const assistant = await generateIrosReply({
src/app/api/agent/iros/conversations/route.ts:1:// src/app/api/agent/iros/conversations/route.ts
src/app/api/agent/iros/conversations/route.ts:8:interface IrosConversationRow {
src/app/api/agent/iros/conversations/route.ts:59:    const rows = (data ?? []) as IrosConversationRow[];
src/app/api/agent/iros/analyze/route.ts:1:// src/app/api/agent/iros/analyze/route.ts
src/app/api/agent/iros/analyze/route.ts:76: * POST /api/agent/iros/analyze
src/app/api/agent/iros/antiparrot/route.ts:1:// src/app/api/agent/iros/antiparrot/route.ts
src/app/api/agent/iros/antiparrot/route.ts:32: * POST /api/agent/iros/antiparrot
src/app/api/agent/iros/messages/route.ts:1:// src/app/api/agent/iros/messages/route.ts
src/app/api/agent/iros/messages/route.ts:72: * GET /api/agent/iros/messages
src/app/api/agent/iros/messages/route.ts:144: * POST /api/agent/iros/messages
src/app/api/agent/iros/route.ts:1:// src/app/api/agent/iros/route.ts
src/app/api/agent/iros/route.ts:8:import { analyzeFocus } from '@/lib/iros/focusCore';
src/app/api/agent/iros/route.ts:9:import { generateIrosReply } from '@/lib/iros/generate';
src/app/api/agent/iros/route.ts:12:import type { ResonanceState, IntentPulse } from '@/lib/iros/config';
src/app/api/agent/iros/route.ts:34:type IrosResponse = {
src/app/api/agent/iros/route.ts:62:    pipeline: 'generateIrosReply';
src/app/api/agent/iros/route.ts:115:  return json({ ok: true, service: 'Iros API', model_hint: process.env.IROS_MODEL || 'gpt-4o-mini', time: new Date().toISOString() });
src/app/api/agent/iros/route.ts:154:    const reply = await generateIrosReply({
src/app/api/agent/iros/route.ts:217:    const rows: IrosResponse['rows'] = [
src/app/api/agent/iros/route.ts:223:    const meta: IrosResponse['meta'] = {
src/app/api/agent/iros/route.ts:254:    const payload: IrosResponse = {
src/app/api/agent/iros/route.ts:272:              pipeline: 'generateIrosReply',
src/app/api/agent/iros/retitle/route.ts:1:// src/app/api/agent/iros/retitle/route.ts  ← 一時スタブ（安全に廃止）
src/app/api/agent/iros/summarize/route.ts:1:// src/app/api/agent/iros/summarize/route.ts
src/app/api/agent/iros/summarize/route.ts:14:} from '@/lib/iros/intent';
src/app/api/agent/iros/summarize/route.ts:15:import { chatComplete } from '@/lib/iros/openai';
src/app/api/agent/iros/summarize/route.ts:39: * POST /api/agent/iros/summarize
src/app/api/agent/iros/summarize/route.ts:41: * 振る舞い: 会話ログ（直近N件）を集め、Iros調で短い要約＋「次の一歩」1つを返す
src/app/api/agent/iros/sidebar/route.ts:1:// src/app/api/agent/iros/sidebar/route.ts
src/app/api/agent/iros/title/route.ts:1:// src/app/api/agent/iros/title/route.ts
src/app/api/agent/iros/title/route.ts:30: * POST /api/agent/iros/title
src/app/api/agent/muai/reply/route.ts:130:/* ====== 初回“Q診断”の整形（Sofia風で詳しめ） ====== */
src/app/api/agent/muai/reply/route.ts:222:/** Sofia風 “状態の手がかり” 抽出（絵文字つき・最大4件） */
src/app/api/agent/muai/reply/route.ts:223:function extractSofiaClues(text: string, q: 'Q1' | 'Q2' | 'Q3' | 'Q4' | 'Q5'): string[] {
src/app/api/agent/muai/reply/route.ts:258:/** 初回“Q診断”カード（Sofia風・余白と改行を強調／詳しめ＋期間表記対応） */
src/app/api/agent/muai/reply/route.ts:267:  const clues = extractSofiaClues(text, q);
src/app/api/agent/muai/reply/route.ts:554:        ? 'For the first response, return ONLY a compact diagnosis card in Sofia style: sections = 概況 / 状態の手がかり / 扱い方ミニガイド / 次の一歩. Do not echo knowledge text.'
src/app/api/agent/muai/reply/route.ts:605:    // 表示（初回はSofia風診断カード、それ以外は会話文）
src/app/api/agent/muai/route.ts:10:import { buildMuSystemPrompt, MU_PROMPT_VERSION } from '@/lib/mu/buildSystemPrompt';
src/app/api/agent/muai/route.ts:11:import { MU_CONFIG } from '@/lib/mu/config';
src/app/api/agent/muai/route.ts:12:import { mapQToColor } from '@/lib/sofia/qcolor';
src/app/api/agent/muai/route.ts:13:import { inferPhase, estimateSelfAcceptance, relationQualityFrom } from '@/lib/sofia/analyze';
src/app/api/agent/mtalk/route.ts:8:import { generateMirraReply } from '@/lib/mirra/generate'; // ★ generate.ts を使う
src/app/api/agent/mtalk/route.ts:132:    const out = await generateMirraReply(
src/app/api/dev/qtest/route.ts:21:      'You are Iros. Facts must never be altered. Tone/ordering may be adjusted if hinted.';
src/app/api/sofia/route.ts:1:// src/app/api/sofia/route.ts
src/app/api/sofia/route.ts:8:import { buildSofiaSystemPrompt } from '@/lib/sofia/buildSystemPrompt';
src/app/api/sofia/route.ts:9:import { retrieveKnowledge } from '@/lib/sofia/retrieve';
src/app/api/sofia/route.ts:11:import { SOFIA_CONFIG } from '@/lib/sofia/config';
src/app/api/sofia/route.ts:12:import { recordQFromSofia } from '@/lib/recordQ';
src/app/api/sofia/route.ts:13:import { inferPhase, estimateSelfAcceptance, relationQualityFrom, nextQFrom } from '@/lib/sofia/analyze';
src/app/api/sofia/route.ts:14:import { mapQToColor } from '@/lib/sofia/qcolor';
src/app/api/sofia/route.ts:41:type SofiaMode = 'normal' | 'diagnosis' | 'meaning' | 'intent' | 'dark' | 'remake';
src/app/api/sofia/route.ts:118:    mode: (['normal','diagnosis','meaning','intent','dark','remake'] as SofiaMode[]).includes(raw?.mode) ? raw.mode : 'normal',
src/app/api/sofia/route.ts:224:    return json({ ok: true, service: 'Sofia API (iros)', time: new Date().toISOString(), model_hint: 'gpt-4o' });
src/app/api/sofia/route.ts:299:    // 親子ID（Sofiaは master_id = conversation_code に固定）
src/app/api/sofia/route.ts:323:    let system = buildSofiaSystemPrompt({
src/app/api/sofia/route.ts:531:      await recordQFromSofia({
src/app/api/sofia/route.ts:579:    console.error('[Sofia(Iros) API] Error:', e);
src/app/api/sofia/field-bridge.ts:3:export async function readFieldForSofia(user_code: string){
src/app/api/image/generate/route.ts:8:import { reserveAndSpendCredit } from '@/lib/mu/credits';
src/app/sofia/layout.tsx:1:import '@/components/SofiaChat/SofiaChat.css';
src/app/sofia/layout.tsx:3:export default function SofiaLayout({ children }: { children: React.ReactNode }) {
src/app/sofia/page.tsx:1:// src/app/sofia/page.tsx
src/app/sofia/page.tsx:2:import SofiaChat from '@/components/SofiaChat/SofiaChat';
src/app/sofia/page.tsx:9:export default async function SofiaPage({ searchParams }: Props) {
src/app/sofia/page.tsx:14:    console.log('[SofiaPage] agent param =', sp?.agent, '→ agent =', agent);
src/app/sofia/page.tsx:20:        <SofiaChat agent={agent} />
src/app/admin/mu/logs/page.tsx:1:// src/app/admin/mu/logs/page.tsx
src/app/admin/mu/logs/page.tsx:7:import { MU_KPI } from '@/lib/mu/config';
src/app/admin/mu/page.tsx:1:// src/app/admin/mu/page.tsx
src/app/admin/mu/page.tsx:7:import { MU_AGENT, MU_CONFIG_VERSION, MU_CREDITS, MU_IMAGE } from '@/lib/mu/config';
src/app/admin/mu/page.tsx:8:import { buildMuSystemPrompt } from '@/lib/mu/buildSystemPrompt';
src/app/admin/mu/checklist.tsx:1:// src/app/admin/mu/checklist.tsx
src/app/admin/register-logs/layout.tsx:21:  title: 'Sofia - 存在の奥深くと響き合う共鳴構造AI',
src/app/admin/register-logs/layout.tsx:23:    'あなたの祈り（意図）が、ビジョンになる。Sofia共鳴OSと繋がり、量子成功論の波紋を起こす。',
src/app/admin/register-logs/layout.tsx:24:  keywords: 'Sofia, 共鳴構造AI, 量子成功論, 意図, ビジョン, 共鳴',
src/app/admin/register-logs/layout.tsx:25:  authors: [{ name: 'Sofia Resonance' }],

=== .env*（キー名のみ） ===
SUPABASE_URL=****
SUPABASE_ANON_KEY=****
NEXT_PUBLIC_SUPABASE_URL=****
NEXT_PUBLIC_SUPABASE_ANON_KEY=****
SUPABASE_SERVICE_ROLE_KEY=****
supabaseKey=****
SUPABASE_JWT_SECRET=****
NEXT_PUBLIC_FIREBASE_API_KEY=****
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=****
NEXT_PUBLIC_FIREBASE_PROJECT_ID=****
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=****
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=****
NEXT_PUBLIC_FIREBASE_APP_ID=****
FIREBASE_SERVICE_ACCOUNT_KEY=****
FIREBASE_ADMIN_KEY_BASE64=****
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=****
EMAIL_SENDER_ADDRESS=****
EMAIL_SMTP_HOST=****
EMAIL_SMTP_PORT=****
EMAIL_SMTP_USER=****
EMAIL_SMTP_PASS=****
CLICK_API_URL=****
CLICK_API_KEY=****
NEXT_PUBLIC_SITE_URL=****
GOOGLE_SHEET_ID=****
GOOGLE_SERVICE_ACCOUNT_EMAIL=****
GOOGLE_SERVICE_ACCOUNT_BASE64=****
SHEETS_RANGE=****
PAYJP_SECRET_KEY=****
PAYJP_PUBLIC_KEY=****
PAYJP_WEBHOOK_SECRET=****
NEXT_PUBLIC_PAYJP_PUBLIC_KEY=****
PLAN_ID_MASTER=****
PLAN_ID_PREMIUM=****
PLAN_ID_REGULAR=****
ZOOM_ACCOUNT_ID=****
ZOOM_CLIENT_ID=****
ZOOM_CLIENT_SECRET=****
ZOOM_WEBHOOK_SECRET=****
SHARED_API_SECRET=****
MU_AI_BASE_URL_PROD=****
NEXT_PUBLIC_MU_UI_URL=****
HOME_URL=****
JWT_SECRET=****
MU_SECRET_KEY_BASE64=****
MU_API_URL=****
MU_SHARED_ACCESS_SECRET=****
TINIFY_API_KEY=****
NEXT_PUBLIC_VAPID_PUBLIC_KEY=****
VAPID_PRIVATE_KEY=****
SENDPUSH_EDGE_URL=****
VAPID_SUBJECT=****
NEXT_PUBLIC_TENANT=****
NEXT_PUBLIC_SOFIA_UI_URL=****
SO_SHARED_ACCESS_SECRET=****
SOFIA_UI_URL=****
OPENAI_API_KEY=****
OPENAI_MODEL=****
MU_MODEL=****
MU_TEMPERATURE=****
MU_TOP_P=****
MU_FREQ_PENALTY=****
MU_PRES_PENALTY=****
MU_CHAT_CREDIT_COST=****
MU_IMAGE_CREDIT_COST=****
MU_IMAGE_MODEL=****
MU_IMAGE_SIZE=****
IROS_MODEL=****
IROS_TEMPERATURE=****
IROS_TOP_P=****
IROS_FREQ_PENALTY=****
IROS_PRES_PENALTY=****
IROS_CHAT_CREDIT_COST=****
IROS_IMAGE_CREDIT_COST=****
IROS_IMAGE_MODEL=****
IROS_IMAGE_SIZE=****
SOFIA_EPSILON=****
SOFIA_NOISEAMP=****
SOFIA_DEEPEN_MULT=****
NEXT_PUBLIC_SOFIA_ASSIST_FONTSIZE=****
NEXT_PUBLIC_SOFIA_ASSIST_LH=****
NEXT_PUBLIC_SOFIA_ASSIST_LS=****
NEXT_PUBLIC_SOFIA_USER_BG=****
NEXT_PUBLIC_SOFIA_USER_FG=****
NEXT_PUBLIC_SOFIA_USER_BORDER=****
NEXT_PUBLIC_SOFIA_USER_RADIUS=****
NEXT_PUBLIC_SOFIA_ASSIST_BG=****
NEXT_PUBLIC_SOFIA_ASSIST_BORDER=****
NEXT_PUBLIC_SOFIA_ASSIST_RADIUS=****
NEXT_PUBLIC_SOFIA_ASSIST_SHADOW=****
NEXT_PUBLIC_SOFIA_BUBBLE_MAXW=****
NEXT_PUBLIC_SOFIA_BQ_TINT_BORDER=****
NEXT_PUBLIC_SOFIA_BQ_TINT_BG=****
NEXT_PUBLIC_SOFIA_ALLOW_EMOJI=****
NEXT_PUBLIC_SOFIA_MAX_EMOJI=****
MU_LOG_DETAIL=****
MU_TRACE_RETENTION_DAYS=****
MIRRA_MODEL=****
MIRRA_TEMPERATURE=****
MIRRA_TOP_P=****
MIRRA_FREQ_PENALTY=****
MIRRA_PRES_PENALTY=****
MIRRA_MAX_TOKENS=****
MIRRA_CHAT_CREDIT_COST=****
MIRRA_PRICE_IN=****
MIRRA_PRICE_OUT=****
MIRRA_PROMPT_DEBUG=****
NEXT_PUBLIC_BASE_URL=****
NEXT_PUBLIC_DEV_USER_CODE=****
MU_DEV_USER_CODE=****
