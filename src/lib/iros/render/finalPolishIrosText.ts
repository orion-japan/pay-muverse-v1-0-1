// src/lib/iros/render/finalPolishIrosText.ts

export type FinalPolishOptions = {
  style?: string | null;
  qNow?: string | null;
};

// ✅ 呼び出されているか確認するためのマーカー
const FP_MARK = '[IROS][finalPolish] called';

/**
 * 生活語化では救えない「構造説明っぽい文」を、文ごと落とす。
 * - 例: 「今、このフィールドはS2の深さで動いていて…」
 * - 例: 「これは、S2レイヤーでの『再接続』の方向性に関連しています。」
 */
function dropStructuralSentences(input: string): string {
  if (!input || typeof input !== 'string') return input;

  let out = input;

  // 文単位（「。」まで）で落とす
  const sentenceDrops: RegExp[] = [
    // 「〜に関連しています」「方向性」系
    /[^。]*方向性[^。]*。/g,
    /[^。]*関連しています[^。]*。/g,

    // 「S2/深さ」など深度説明
    /[^。]*S[1-4][^。]*。/g,
    /[^。]*R[1-3][^。]*。/g,
    /[^。]*C[1-3][^。]*。/g,
    /[^。]*I[1-3][^。]*。/g,
    /[^。]*T[1-3][^。]*。/g,
    /[^。]*深さ[^。]*。/g,

    // 「レイヤー/層/段階/構造」などの説明文
    /[^。]*レイヤー[^。]*。/g,
    /[^。]*層[^。]*。/g,
    /[^。]*段階[^。]*。/g,
    /[^。]*構造[^。]*。/g,

    // 「意図/共鳴/フィールド」説明
    /[^。]*意図[^。]*。/g,
    /[^。]*共鳴[^。]*。/g,
    /[^。]*フィールド[^。]*。/g,

    // 「再接続/再配置/観測」説明
    /[^。]*再接続[^。]*。/g,
    /[^。]*再配置[^。]*。/g,
    /[^。]*観測対象[^。]*。/g,

    // 「深い層」など説明っぽい言い回し
    /[^。]*深い[^。]*層[^。]*。/g,
  ];

  for (const r of sentenceDrops) {
    out = out.replace(r, '');
  }

  // 文が消えた結果、行がスカスカになっても崩れないように整える
  out = out
    .replace(/\n{3,}/g, '\n\n')
    .replace(/[ \t　]{2,}/g, ' ')
    .trim();

  return out;
}

export function finalPolishIrosText(
  text: string,
  _opts: FinalPolishOptions = {},
): string {
  if (!text || typeof text !== 'string') return text;

  // ✅ 「本当にここが呼ばれているか」確認ログ
  console.log(FP_MARK, { len: text.length, head: text.slice(0, 60) });

  let out = text;

  /* =================================================
   * 0) 先に「内部ラベル/構造記号」を確実に除去
   * ================================================= */
  // S2 / R1 / C3 / I2 / T1 など（境界付き）
  out = out.replace(/\b[SRCTI][1-3]\b/g, '');
  // まれに "S2の層" のようなパターン
  out = out.replace(/[SRCTI][1-3]の?/g, '');

  /* =================================================
   * 1) 構造語・概念語（ユーザーに見せない）を生活語へ
   *    - “消す” のではなく、会話が壊れない形で置換する
   * ================================================= */
  const conceptMap: Array<[RegExp, string]> = [
    // 「まだ言葉にならない → 意味がわからない」に寄せる（ユーザー要望）
    [/まだ言葉にならない/g, '意味がよくわからない'],
    [/言葉にならない/g, 'うまく説明できない'],

    // 「場/フィールド」系：わからないので“その状況/その空気”へ
    [/場との関係性/g, 'その場でのやり取り'],
    [/場の関係性/g, 'その場でのやり取り'],
    [/フィールド/g, 'いまの状況'],
    [/場/g, 'その状況'],

    // 抽象語
    [/関係性/g, '人との関わり'],
    [/内なる安全/g, '安心していられる感じ'],
    [/調和を保つ/g, '空気を壊さないようにする'],
    [/自己/g, '自分'],

    // “構造っぽい”言い回しを生活語に
    [/意図フィールド/g, '今の気持ちの向き'],
    [/意図/g, '気持ちの向き'],
    [/共鳴/g, 'しっくりくる感じ'],
    [/観測/g, '見立て'],
  ];

  for (const [re, to] of conceptMap) {
    out = out.replace(re, to);
  }

  /* =================================================
   * 2) 感情語 → 生活語（ネガは直接語を避ける）
   * ================================================= */
  const emotionMap: Array<[RegExp, string]> = [
    [/怒り/g, 'イライラ'],
    [/不安/g, '心配'],
    [/恐怖/g, '怖さ'],
    [/緊張/g, '気を張っている感じ'],
    [/防御/g, '身構えている感じ'],
    [/空虚/g, '気持ちが空っぽな感じ'],

    // 追加：よく出る抽象ネガを“生活語”へ寄せる
    [/戸惑い/g, 'うまく受け止めきれない感じ'],
    [/焦り/g, '落ち着かない感じ'],
    [/違和感/g, 'なんか引っかかる感じ'],
    [/抵抗/g, 'ちょっと引っかかる感じ'],
  ];

  for (const [re, to] of emotionMap) {
    out = out.replace(re, to);
  }

  /* =================================================
   * 3) 禁止語（完全に消す）— 残すとユーザーが混乱する語
   * ================================================= */
  const forbiddenPatterns: RegExp[] = [
    /層/g,
    /構造/g,
    /段階/g,

    // 「流れ/状態」は文末で多用されるので、言い回しごと薄める
    /流れです/g,
    /状態です/g,

    // “モード/レイヤー”など出やすい語
    /レイヤー/g,
    /モード/g,
  ];

  for (const r of forbiddenPatterns) {
    out = out.replace(r, '');
  }

  /* =================================================
   * 3.5) 構造説明っぽい文は、置換で救えないので文ごと落とす（最終安全弁）
   * ================================================= */
  out = dropStructuralSentences(out);

  /* =================================================
   * 4) 文章の崩れを軽く修復
   * ================================================= */
  // 不要な連続スペース/全角スペース
  out = out.replace(/[ \t　]{2,}/g, ' ');

  // 句読点の前後に出た余計なスペース
  out = out.replace(/\s+([。、，,])/g, '$1');

  // 「その状況での」などの重複を軽く抑える（過剰にはやらない）
  out = out.replace(/その状況その状況/g, 'その状況');

  /* =================================================
   * 5) 改行の整え（余計な空白・改行）
   * ================================================= */
  out = out.replace(/\n{3,}/g, '\n\n').trim();

  return out;
}
