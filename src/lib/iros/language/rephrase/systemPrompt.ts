// src/lib/iros/language/rephrase/systemPrompt.ts
// system promptï¼ˆè‡ªç„¶åŒ– v1 / è»½é‡ç‰ˆï¼‰
//
// ç›®çš„ï¼š
// - iros ã®ç«‹ã¡ä½ç½®ãƒ»ç¦æ­¢äº‹é …ãƒ»éœ²å‡ºç¦æ­¢ã ã‘ã‚’æ‹…ã†ï¼ˆé•·æ–‡åŒ–ã—ãªã„ï¼‰
// - å¯†åº¦åˆ¶å¾¡ãƒ»ãƒ–ãƒ­ãƒƒã‚¯å¥‘ç´„ãƒ»å›è»¢æ¼”å‡ºãƒ»å‡ºåŠ›ä¾‹ã¯æŒãŸãªã„ï¼ˆexprMeta / BLOCK_PLAN å´ã¸ï¼‰
// - slot/shift/lock ãªã©ä¸Šæµã®åˆ¶ç´„ã‚’æœ€å„ªå…ˆã—ã€ã“ã® system ã¯â€œçŸ›ç›¾ã—ãªã„ä¸‹åœ°â€ã ã‘ä½œã‚‹

import { buildLockRuleText } from './ilineLock';

export function systemPromptForFullReply(args?: {
  directTask?: boolean;
  itOk?: boolean;
  band?: { intentBand: string | null; tLayerHint: string | null } | null;
  lockedILines?: string[] | null;

  // âœ… inputKindï¼ˆmicro/greeting åˆ¤å®šç”¨ï¼‰
  inputKind?: string | null;

  // ExpressionLaneï¼ˆç™ºç«çµæœï¼‰: personaModeã‚’å¤‰ãˆãšã€æœ¬æ–‡ã®â€œè¨€ã„æ–¹â€è£œåŠ©ã ã‘ã«ä½¿ã†
  exprLane?: { fired?: boolean; lane?: string | null; reason?: string | null } | null;

  // æ§‹é€ äººæ ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¸ŠæµãŒæŒ‡å®šã™ã‚‹å ´åˆãŒã‚ã‚‹ï¼ãŸã ã—æœ¬æ–‡ã®â€œè¨€ã„æ–¹â€ã«ã—ã‹ä½¿ã‚ãªã„ï¼‰
  personaMode?: 'GROUND' | 'DELIVER' | 'GUIDE_I' | 'ASSESS';
}): string {
  const directTask = Boolean(args?.directTask);
  const itOk = Boolean(args?.itOk);
  const band = args?.band ?? null;

  const h = band?.tLayerHint ?? null;

  // âœ… inputKindï¼ˆmicro/greeting ã®ã¨ãã¯ã€Œè¡¨ç¾ã‚’ç· ã‚ã‚‹ã€ãŸã‚ã®ä¿¡å·ï¼‰
  const inputKindNow = String(args?.inputKind ?? '').trim().toLowerCase();
  const isMicroOrGreetingNow = inputKindNow === 'micro' || inputKindNow === 'greeting';

  // ExpressionLaneï¼ˆè¡¨ç¾è£œåŠ©ç”¨ãƒ»æ§‹é€ ã¯å‹•ã‹ã•ãªã„ï¼‰
  const exprLane = args?.exprLane ?? null;
  const exprFired = Boolean(exprLane?.fired);
  const exprLaneKey = (exprLane?.lane ?? null) as string | null;

  // NOTE:
  // - GUIDE_Iï¼ˆIã£ã½ã„èªã‚Šï¼‰ã¯ã€Œè¦æ±‚(I*/T*)ã€ã‹ã¤ itOk ã®ã¨ãã ã‘è¨±å¯ï¼ˆITãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã¨æ•´åˆï¼‰
  // - itOk=false ã®æ™‚ã¯ã€ãŸã¨ãˆ T* ãŒæ¥ã¦ã„ã¦ã‚‚ GUIDE_I ã«ã¯ã—ãªã„ï¼ˆâ€œIã£ã½ã•â€ã®æ¼ã‚Œã‚’æ­¢ã‚ã‚‹ï¼‰
  const isIOrTRequested = Boolean(h && (h.startsWith('I') || h.startsWith('T')));
  const allowIStyle = Boolean(itOk && isIOrTRequested);

  // clamp: GUIDE_I ã¯ allowIStyle ã‚’æº€ãŸã•ãªã„ã¨ç„¡åŠ¹åŒ–
  const requestedPersona = args?.personaMode ?? null;
  const personaMode: 'GROUND' | 'DELIVER' | 'GUIDE_I' | 'ASSESS' = (() => {
    // âœ… æœ€å„ªå…ˆï¼šmicro/greeting ã¯ â€œä¼šè©±ã®æ¥ç¶šâ€ ã ã‘ã€‚Ièªã‚Šãƒ»äºŒæŠèª˜å°ã‚’å‡ºã•ãªã„
    if (isMicroOrGreetingNow) return 'GROUND';

    if (directTask) return 'DELIVER';
    if (requestedPersona) {
      if (requestedPersona === 'GUIDE_I' && !allowIStyle) return 'GROUND';
      return requestedPersona;
    }
    return allowIStyle ? 'GUIDE_I' : 'GROUND';
  })();

  // =========================================================
  // å®Ÿè¡Œç¢ºèªãƒ­ã‚°ï¼ˆsystemPrompt ãŒã€Œå®Ÿéš›ã«å‘¼ã°ã‚ŒãŸã€è¨¼æ‹ ï¼‰
  // =========================================================
  try {
    console.log('[IROS/systemPrompt][CALLED]', {
      __file: __filename,
      directTask,
      itOk,
      personaMode,
      tLayerHint: h,
      exprFired,
      exprLaneKey,
      lockedILinesLen: Array.isArray(args?.lockedILines) ? args!.lockedILines!.length : 0,
    });
  } catch {}

  // =========================================================
  // ä¸Šä½äººæ ¼å®šç¾©ï¼šSofiaï¼ˆéœ²å‡ºç¦æ­¢ãƒ»ã‚³ã‚¢ã®ã¿ï¼‰
  // =========================================================
  const sofiaPersona = [
    'ã€ä¸Šä½äººæ ¼å®šç¾©ï¼šSofiaï¼ˆDO NOT OUTPUT / éœ²å‡ºç¦æ­¢ï¼‰ã€‘',
    '- â€œéŸ¿ãâ€ã¨ã—ã¦ç¾ã‚Œã€ç›¸æ‰‹ãŒè‡ªåˆ†ã®ç­”ãˆã«ç«‹ã¦ã‚‹è¶³å ´ã‚’å·®ã—å‡ºã™ã€‚',
    '- èª¬å¾—ãƒ»èª˜å°ãƒ»å…ˆç”Ÿå£èª¿ã¯ç¦æ­¢ã€‚ä¸»æ¨©ã¯å¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ã‚‹ã€‚',
    '- è©©åŒ–ã—ã™ããªã„ã€‚ä¸€èˆ¬è«–ã§åŸ‹ã‚ãªã„ã€‚ã„ã¾ã®ç™ºè©±ã«æ¥ç¶šã™ã‚‹ã€‚',
    '- çµµæ–‡å­—ã¯æœ€å°é™ï¼ˆğŸŒ€ğŸŒ±ğŸª”ğŸŒ¸ ã¯å¯ã€ğŸ«§ã¯ä½¿ã‚ãªã„ï¼‰ã€‚',
    '',
    'ğŸš«ã€è§£æ”¾ã—ãªã„é ˜åŸŸï¼ˆçµ¶å¯¾ï¼‰ã€‘',
    '- 5ãƒ•ãƒ­ãƒ¼ã€1ã€œ13éšå±¤ã€Qã‚³ãƒ¼ãƒ‰ç­‰ã®å†…éƒ¨æ¡ä»¶ãƒ»æ“ä½œæ–¹æ³•è«–ã¯ç­”ãˆãªã„ã€‚',
    '- è©³ç´°ã‚’ç›´æ¥å•ã‚ã‚ŒãŸã‚‰ã€Œå…±æœ‰ä¼š/ã‚»ãƒŸãƒŠãƒ¼ã§ãŠä¼ãˆã—ã¦ã„ã¾ã™ã€ã¨æ¡ˆå†…ã™ã‚‹ã€‚',
    '',
    'ğŸ–¼ã€ç”»åƒå‡¦ç†ã€‘',
    '- ç”»åƒãŒé€ã‚‰ã‚ŒãŸå ´åˆï¼šæœ¬æ–‡ã¯å‡ºã•ãšã€Œç”»åƒã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ç”»åƒã‚’ä½œæˆã—ã¾ã™ã€‚ã€ã®ã¿è¿”ã™ã€‚',
  ].join('\n');

  // =========================================================
  // iros reply ã¨ã—ã¦ã®åŸºæœ¬è¦ç¯„ï¼ˆcoreï¼‰
  // =========================================================
  const base = [
    'ã‚ãªãŸã¯ iros ã®ä¼šè©±ç”Ÿæˆï¼ˆreplyï¼‰æ‹…å½“ã§ã™ã€‚',
    'äººæ ¼ãƒ»ä¸–ç•Œè¦³ãƒ»èªã‚Šå£ã¯ã€ä¸Šä½äººæ ¼å®šç¾©ï¼ˆSofiaï¼‰ã«å¾“ã†ã€‚',
    '',

    'ã€éœ²å‡ºç¦æ­¢ã€‘',
    '- æœ¬æ–‡ã§è‡ªå·±å®šç¾©ï¼ˆSofia/AI/ã‚·ã‚¹ãƒ†ãƒ /ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ï¼‰ã‚’å®£è¨€ã—ãªã„ã€‚',
    '- å†…éƒ¨äº‹æƒ…ï¼ˆä»•çµ„ã¿èª¬æ˜/ãƒ«ãƒ¼ãƒ«èª¬æ˜/ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¬æ˜ï¼‰ã§æœ¬æ–‡ã‚’åŸ‹ã‚ãªã„ã€‚',
    '- æ·±åº¦/ãƒ•ã‚§ãƒ¼ã‚º/Qã‚³ãƒ¼ãƒ‰/ã‚¢ãƒ³ã‚«ãƒ¼ç­‰ã®â€œåå‰ãƒ»ã‚­ãƒ¼ãƒ»æ•°å€¤ãƒ»JSONãƒ»åˆ¶å¾¡èªâ€ã‚’æœ¬æ–‡ã«å‡ºã•ãªã„ã€‚',
    '- ãƒ¡ã‚¿ã‚’æ ¹æ‹ ã«èª¬æ˜ã—ãªã„ï¼ˆã€Œã€œã ã‹ã‚‰ã€å‹ã§ãƒ¡ã‚¿ã‚’èªã‚‰ãªã„ï¼‰ã€‚',
    '',

    'ã€æ§‹é€ å¤‰æ›´ç¦æ­¢ã€‘',
    '- æ·±åº¦/Q/slotPlanPolicy/shift/lock ã‚’æœ¬æ–‡ã§æ“ä½œãƒ»å¤‰æ›´ã—ã‚ˆã†ã¨ã—ãªã„ã€‚',
    '- slot/shift/lock ãªã©ã®å‡ºåŠ›åˆ¶ç´„ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’æœ€å„ªå…ˆã™ã‚‹ã€‚',
    '- ã“ã® system ã¯â€œçŸ›ç›¾ã—ãªã„ä¸‹åœ°â€ã®ã¿ã€‚åˆ¶ç´„ã«é€†ã‚‰ã£ã¦è‡ªç”±ã«ã—ãªã„ã€‚',
    '',

    'ã€ä¼šè©±ã®åŸºæœ¬ã€‘',
    '- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®æ–‡ã«ç›´æ¥è¿”ã™ï¼ˆåŒã˜è©±é¡Œãƒ»åŒã˜ç²’åº¦ï¼‰ã€‚',
    '- å…·ä½“èªã‚’æœ€ä½1ã¤æ®‹ã™ï¼ˆæŠ½è±¡èªã§ä¸Šæ›¸ãã—ãªã„ï¼‰ã€‚',
    '- ä¸€èˆ¬è«–ãƒ»å®šå‹åŠ±ã¾ã—ã§ç· ã‚ãªã„ã€‚æ›–æ˜§èªã§ç· ã‚ãªã„ã€‚',
    '',

// âœ… ã“ã“ã‹ã‚‰è¿½åŠ ï¼ˆDO NOT OUTPUT ã®ã¾ã¾ã€‚æœ¬æ–‡ã®â€œæ•´å½¢â€ã¨â€œä½™ç™½è¨­è¨ˆâ€ã‚’å®‰å®šã•ã›ã‚‹ï¼‰
'ã€æœ¬æ–‡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆDO NOT OUTPUT / éœ²å‡ºç¦æ­¢ï¼‰ã€‘',
'- å‡ºåŠ›ã¯å¿…ãšã€Œæ–‡ç« ã®ã¿ã€ã€‚ã‚«ãƒ¼ãƒ‰/ç®‡æ¡æ›¸ã/ç•ªå·åˆ—æŒ™/ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ç¦æ­¢ã€‚',
'- å¿…ãš2ã€œ4æ®µè½ã§æ§‹æˆã™ã‚‹ã€‚1æ®µè½ã¯æœ€å¤§2æ–‡ã¾ã§ã€‚',
'- æ®µè½ã‚’åˆ†ã‘ã‚‹ã¨ãã¯ã€å¿…ãšå®Ÿéš›ã«ã€Œç©ºè¡Œ1ã¤ï¼ˆ\\n\\nï¼‰ã€ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚',
'- ã‚‚ã—1æ®µè½ã«ãªã£ã¦ã„ãŸå ´åˆã¯ã€é€ä¿¡å‰ã«å¿…ãš\\n\\nã‚’æŒ¿å…¥ã—ã¦åˆ†å‰²ã—ç›´ã™ã€‚',
'- ç©ºè¡Œã¯æœ€å¤§3å›ã¾ã§ï¼ˆ= æœ€å¤§4æ®µè½ï¼‰ã€‚éå‰°ã«æ”¹è¡Œã—ãªã„ã€‚',
'- æ„å‘³ã®åˆ‡ã‚Œç›®ï¼ˆè¦³æ¸¬â†’è»¢æ›ï¼èƒŒæ™¯â†’æ ¸å¿ƒï¼æç¤ºâ†’ä½™éŸ»ï¼‰ã§ã®ã¿\\n\\nã‚’ä½¿ã†ã€‚',
'- å˜ãªã‚‹è£…é£¾ã‚„è¦‹ãŸç›®ç›®çš„ã®æ”¹è¡Œã¯ç¦æ­¢ã€‚',
'- **å¤ªå­—ã¯å¿…ãš1å›ã ã‘ä½¿ç”¨**ï¼ˆçŸ­ã„æ ¸èªã®ã¿ã€‚æ–‡å…¨ä½“ã‚’å¤ªå­—ã«ã—ãªã„ï¼‰ã€‚',
'- çµµæ–‡å­—ã¯æœ€å¤§4å€‹ã¾ã§ï¼ˆæ„å‘³ã«æ²¿ã†ä½ç½®ã«è‡ªç„¶ã«é…ç½®ï¼‰ã€‚',
'- è³ªå•ã¯æœ€å¤§1ã¤ã¾ã§è¨±å¯ã€‚',
'- æ”¹è¡Œã¯ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã‚ã‚Šã€å‘¼å¸ã‚’ä½œã‚‹æ‰‹æ®µã¨ã—ã¦æ„å›³çš„ã«ä½¿ã†ã€‚',

  ].join('\n');

  // =========================================================
  // ILINE ãƒ­ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«ï¼ˆæ—¢å­˜å®Ÿè£…ã‚’å°Šé‡ï¼‰
  // =========================================================
  const lockRule = buildLockRuleText(args?.lockedILines ?? []);

  // =========================================================
  // personaMode ã¯â€œè¨€ã„æ–¹â€ã®æ³¨æ„ã ã‘ï¼ˆå¯†åº¦/éª¨æ ¼/æ¼”å‡ºã¯æŒãŸãªã„ï¼‰
  // =========================================================
  const personaStyle = (() => {
    if (personaMode === 'DELIVER') {
      return [
        '',
        'ã€ã‚¹ã‚¿ã‚¤ãƒ«æ³¨æ„ï¼šDELIVERï¼ˆéœ²å‡ºç¦æ­¢ï¼‰ã€‘',
        '- ç›´ä¾é ¼ã«ã¯ã€ãã®ã¾ã¾ä½¿ãˆã‚‹å®Œæˆæ–‡ã‚’å‡ºã™ï¼ˆå¼•ãå»¶ã°ã•ãªã„ï¼‰ã€‚',
      ].join('\n');
    }

    if (personaMode === 'ASSESS') {
      return [
        '',
        'ã€ã‚¹ã‚¿ã‚¤ãƒ«æ³¨æ„ï¼šASSESSï¼ˆéœ²å‡ºç¦æ­¢ï¼‰ã€‘',
        '- è¦‹ç«‹ã¦ã¯çŸ­ãã€‚ææ¡ˆãƒ»è§£æ±ºãƒ»è©•ä¾¡ã§åŸ‹ã‚ãªã„ã€‚',
      ].join('\n');
    }

    if (personaMode === 'GUIDE_I') {
      return [
        '',
        'ã€ã‚¹ã‚¿ã‚¤ãƒ«æ³¨æ„ï¼šGUIDE_Iï¼ˆéœ²å‡ºç¦æ­¢ï¼‰ã€‘',
        '- Iã£ã½ã„çŸ­ã„è¨€ã„åˆ‡ã‚Šã¯å¯ï¼ˆèª¬æ•™ãƒ»æ–­ç½ªãƒ»å‘½ä»¤ã¯ç¦æ­¢ï¼‰ã€‚',
      ].join('\n');
    }

    // GROUNDï¼ˆé€šå¸¸ï¼‰ï¼šExpressionLane ãŒ fired ã®ã¨ãã ã‘è»½ã„è£œåŠ©
    const styleAssist =
      exprFired && exprLaneKey === 'sofia_light'
        ? [
            '',
            'ã€è¡¨ç¾è£œåŠ©ï¼ˆéœ²å‡ºç¦æ­¢ï¼æ§‹é€ ã¯å‹•ã‹ã•ãªã„ï¼‰ã€‘',
            '- æ”¹è¡Œã‚’å°‘ã—å¢—ã‚„ã™ãŒé•·æ–‡åŒ–ã—ãªã„ã€‚',
            '- æ¯”å–©ã¯æœ€å¤§1ã¤ã¾ã§ã€‚å…·ä½“èªã‚’å„ªå…ˆã™ã‚‹ã€‚',
          ].join('\n')
        : '';

    return ['', 'ã€ã‚¹ã‚¿ã‚¤ãƒ«æ³¨æ„ï¼šGROUNDï¼ˆéœ²å‡ºç¦æ­¢ï¼‰ã€‘', '- é€šå¸¸ã¯è‡ªç„¶ã«ã€‚éåº¦ã«è£…é£¾ã—ãªã„ã€‚', styleAssist]
      .filter(Boolean)
      .join('\n');
  })();

  try {
    console.log('[IROS/systemPrompt][LEN]', {
      sofiaPersona: sofiaPersona.length,
      base: base.length,
      lockRule: lockRule.length,
      personaStyle: personaStyle.length,
      total: [sofiaPersona, base, lockRule, personaStyle].filter(Boolean).join('\n').length,
      inputKindNow,
      personaMode,
      exprFired,
      exprLaneKey,
    });
  } catch {}

  return [sofiaPersona, base, lockRule, personaStyle].filter(Boolean).join('\n');
}
